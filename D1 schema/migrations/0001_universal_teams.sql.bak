-- Migration: Universal Teams (Teams, TeamMembers, EventTeams)
-- Objective: Consolidate war_teams and event_participants into a unified Team structure.

PRAGMA foreign_keys = OFF;

-- 1. Create New Tables
CREATE TABLE IF NOT EXISTS teams (
  team_id       TEXT PRIMARY KEY,
  name          TEXT NOT NULL,
  description   TEXT,
  is_locked     INTEGER NOT NULL DEFAULT 0 CHECK (is_locked IN (0, 1)),
  created_by    TEXT, -- Optional, for auditing
  created_at_utc    TEXT NOT NULL DEFAULT (strftime('%Y-%m-%d %H:%M:%S', 'now')),
  updated_at_utc    TEXT NOT NULL DEFAULT (strftime('%Y-%m-%d %H:%M:%S', 'now'))
);

CREATE TABLE IF NOT EXISTS team_members (
  team_id       TEXT NOT NULL REFERENCES teams(team_id) ON DELETE CASCADE,
  user_id       TEXT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  role_tag      TEXT, -- 'Leader', 'Healer', etc.
  sort_order    INTEGER NOT NULL DEFAULT 0,
  joined_at_utc     TEXT NOT NULL DEFAULT (strftime('%Y-%m-%d %H:%M:%S', 'now')),
  PRIMARY KEY (team_id, user_id)
);

CREATE TABLE IF NOT EXISTS event_teams (
  event_id      TEXT NOT NULL REFERENCES events(event_id) ON DELETE CASCADE,
  team_id       TEXT NOT NULL REFERENCES teams(team_id) ON DELETE CASCADE,
  assigned_at_utc   TEXT NOT NULL DEFAULT (strftime('%Y-%m-%d %H:%M:%S', 'now')),
  PRIMARY KEY (event_id, team_id)
);

CREATE INDEX IF NOT EXISTS idx_team_members_user ON team_members(user_id);
CREATE INDEX IF NOT EXISTS idx_event_teams_event ON event_teams(event_id);
CREATE INDEX IF NOT EXISTS idx_event_teams_team ON event_teams(team_id);


-- 2. Migrate Data

-- A. Migrate Existing War Teams -> teams + event_teams
-- We assume war_teams.war_id links to war_history(war_id) w/ event_id
-- BUT war_teams.war_id = war_history.war_id, and war_history.event_id is the Event.
-- IF war_history doesn't exist for some reason, we might lose mapping, but assume consistency.

-- Insert into teams
INSERT INTO teams (team_id, name, description, is_locked, created_at_utc, updated_at_utc)
SELECT 
  war_team_id, 
  name, 
  note, 
  is_locked, 
  created_at_utc, 
  updated_at_utc 
FROM war_teams;

-- Insert into event_teams (Linking the new Team to the War Event)
-- Join war_teams -> war_history -> events
INSERT INTO event_teams (event_id, team_id, assigned_at_utc)
SELECT 
  wh.event_id,
  wt.war_team_id,
  wt.created_at_utc
FROM war_teams wt
JOIN war_history wh ON wt.war_id = wh.war_id
WHERE wh.event_id IS NOT NULL;


-- B. Migrate War Team Members -> team_members
INSERT INTO team_members (team_id, user_id, role_tag, sort_order, joined_at_utc)
SELECT 
  war_team_id,
  user_id,
  role_tag,
  sort_order,
  created_at_utc
FROM war_team_members;


-- C. Migrate Event Participants (Signups) -> New "Pool" Teams
-- For each event with participants, we need a "Unassigned/Pool" team.
-- We can generate a UUID for the team_id. Since SQLite doesn't have uuid(), we might use randomblob or similar, 
-- but given this is a one-time script, we can concatenate 'pool-' || event_id for migration simplicity if UUIDs are strictly required to be random this might be risky, 
-- but usually ID collision on 'pool-' || event_id is impossible.
-- wait, team_id is usually UUID. 'pool-' || event_id is a string. If existing IDs are UUIDs, this format is distinct.
-- Let's use 'pool-' || event_id as the ID for the migration pool teams.

-- Create Pool Teams for every event that has participants
INSERT INTO teams (team_id, name, description, created_at_utc, updated_at_utc)
SELECT DISTINCT
  'pool-' || event_id,
  'Unassigned (Pool)',
  'Auto-generated pool team from migration',
  strftime('%Y-%m-%d %H:%M:%S', 'now'),
  strftime('%Y-%m-%d %H:%M:%S', 'now')
FROM event_participants;

-- Link Pool Teams to Events
INSERT INTO event_teams (event_id, team_id, assigned_at_utc)
SELECT DISTINCT
  event_id,
  'pool-' || event_id,
  strftime('%Y-%m-%d %H:%M:%S', 'now')
FROM event_participants;

-- Move Participants into Pool Teams
INSERT INTO team_members (team_id, user_id, joined_at_utc)
SELECT 
  'pool-' || event_id,
  user_id,
  joined_at_utc
FROM event_participants;


-- 3. Drop Legacy Tables
-- (Depending on safety preference, we might renamed them first, but implementation plan said 'Drop')
DROP TABLE war_team_members;
DROP TABLE war_teams;
DROP TABLE war_pool_members;
DROP TABLE event_participants;

-- 4. Re-enable Foreign Keys
PRAGMA foreign_keys = ON;
